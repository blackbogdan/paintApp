<!doctype html>
<html>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.js">// for dropdowns to work</script>
<!-- <script type="text/javascript" src="{{ url_for('static', filename='bootstrap.min.js') }}"></script> -->
<script type="text/javascript" src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
<link rel="stylesheet" media="screen" href = "{{ url_for('static', filename='bootstrap.css') }}">
<!-- <link rel="stylesheet" media="screen" href = "{{ url_for('static', filename='bootstrap.min.css') }}"> -->
<head>
<title>Paint</title>
</head>
<body style="background-color: ivory">
<div class="btn-group">
    <button type="button" class="btn btn-info" id="toolselect" aria-haspopup="true" aria-expanded="false" value="brush">Brush</button>
    <button type="button" data-toggle="dropdown" class="btn btn-info dropdown-toggle" aria-haspopup="true" aria-expanded="false"><span class="caret"></span></button>
    <ul class="dropdown-menu" id="toolsList">
        <li class="dropdown-item" value="brush">Brush</li>
        <li class="dropdown-item" value="rect">Rectangle</li>
        <li class="dropdown-item" value="line">Line</li>
        <li class="dropdown-item" value="circle">Circle</li>
    </ul>
</div>
<script>
// For bootstrap dropdown to behave like toolselect value
$("#toolsList li").click(function(){
  var selText = $(this).text();
  var curValue = $(this).attr('value');
  $("#toolselect").html(selText);
  $("#toolselect").attr("value", curValue);
});
</script>

<label id="imagelabel"> Image name </label>
    <input id="imagename" name="imagename">
    <input id="save" type=button value="save" onclick = "saveImage()">
    <input id="load" type=button value="load" onclick = "loadImage()">
    <input id="clear" type=button class="btn btn-info" value="Clear" onclick = "clearCanvas()"  >
</div>
</body>
<table id="table" >
   <tr>
    <td><button onclick="fillColor('red')" style="background-color: red; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('green')" style="background-color: green; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('blue')" style="background-color: blue; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('yellow')" style="background-color: yellow; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('pink')" style="background-color: pink; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('purple')" style="background-color: purple; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('brown')" style="background-color: brown; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('violet')" style="background-color: violet; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('white')" style="background-color: white; height: 20px; width: 20px;"></button></td>
    <td><button onclick="fillColor('black')" style="background-color: black; height: 20px; width: 20px;"></button></td>
    </tr>
</table>

<div>
        {% for color in colors_lst %}
            <label class="radio-inline">{{ color }}<input type="radio" name="optradio" onclick="fillColor('{{color}}')">
            </label>
        {% endfor %}
</div>

<div class="btn-group" role="group" aria-label="...">
  <button type="button" class="btn btn-primary">Left</button>
  <button type="button" class="btn btn-primary">Middle</button>
  <button type="button" class="btn" style="{
    background-color: #8064A2;
    border-color: #8064A2;
}">Right</button>
</div>
<div>
<canvas id="canvas1" width="300" height="300" style="border:1px solid #FF0000;position: absolute;top: 150px;left: 450px; "></canvas>
<canvas id="canvas" width="400" height="400" style="border:2px solid #000000;position: absolute;top: 100px;left: 400px; "></canvas>
</div>
<div>
<input id="logArr" type=button value="logArr" onclick = "logArr()">
<input id="arrToPython" class="btn btn-info" type=button value="Analyse Image" onclick = "arrToPython()">
</div>
<label><a href="result">Go to "Results" page</a></label>

<h4 id="calculatedResult" >Will be replaced</h4>


<script>
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');
// this is important, otherwise canvas will have rgb 0,0,0 instead of 255, 255, 255
// context.fillStyle="#FFFFFF";
context.fillStyle="#000000";
context.fillRect(0, 0, canvas.width, canvas.height);
var canvas1 = document.getElementById('canvas1');
var context1 = canvas1.getContext('2d');

var beginX;
var beginY;
var radius;
var endX;
var endY;
var sideX;
var sideY;
var select;
var currentColor = 'white';  // initialazie the default color

// For brush drawing
var clickX = new Array();
var clickY = new Array();
var clickDrag = new Array();  // So it would not draw on click 
var paint;
// End of for brush

var data = {"line":[], "rect":[], "circle":[]}

init();

function init() {     
    var dataString = "{{ saved }}";
    if (dataString) {
        data = JSON.parse(dataString.replace(/&#34;/g,'"'));
        drawAll();
    }    
    return;
}

canvas.addEventListener('mousedown', function(evt) {
        var mousePos = getMousePos(canvas, evt);
        select = 1;
        beginX = mousePos.x;
        beginY = mousePos.y;
        if (toolselect.value == 'brush'){
            clickX.push(beginX);
            clickY.push(beginY);
            clickDrag.push(false);
        }
}, false);

canvas.addEventListener('mousemove', function(evt) {
        var mousePos = getMousePos(canvas, evt);
        if (select && toolselect.value == 'rect' ) {
            sideX = mousePos.x-beginX;
            sideY = mousePos.y-beginY;
            drawRect(beginX, beginY, sideX, sideY);
        }
        if (select && toolselect.value == 'line' ) {
            endX = mousePos.x;
            endY = mousePos.y; 
            drawLine(beginX, beginY, endX, endY);
        } 
        if (select && toolselect.value == 'circle' ) {
            radius = mousePos.x-beginX;
            drawCircle(beginX, beginY, radius);
        }
        if (select && toolselect.value == 'brush' ) {
            // radius = mousePos.x-beginX;dc
            var mousePos = getMousePos(canvas, evt);
            beginX = mousePos.x;
            beginY = mousePos.y;
            clickX.push(beginX);
            clickY.push(beginY);
            clickDrag.push(true)
            drawBrush();
        }
}, false);
      
canvas.addEventListener('mouseup', function(evt) {
        var mousePos = getMousePos(canvas, evt);
        select = 0;
        // context1.drawImage(canvas,0,0);
        if (toolselect.value == 'line') {
            data.line.push({"beginx":beginX, "beginy":beginY, "endx":endX, "endy":endY, "color":currentColor}); 
        } 
        if (toolselect.value == 'rect') {              
            data.rect.push({"beginx":beginX, "beginy":beginY, "sidex":sideX, "sidey":sideY, "color":currentColor});   
        } 
        if (toolselect.value == 'circle') {
            data.circle.push({"beginx":beginX, "beginy":beginY, "radius":radius, "color":currentColor});  
        }
        if (toolselect.value == 'brush') {
            var clickX = new Array();
            var clickY = new Array();
            var clickDrag = new Array()
        }
        
}, false);
      

function logArr() {
    // var canv = document.getElementById('canvas');
    // var ctx = canvas.getContext('2d');
    var ctx = context;
    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var arr = [];
    var data = imageData.data;
    for (var i = 0; i < data.length; i += 4) {
        arr.push(data[i], data[i+1], data[i+2]);
      // data[i]     = data[i];     // red
      // data[i + 1] = data[i + 1]; // green
      // data[i + 2] = data[i + 2]; // blue
    }
    console.log("arr after: " + arr);
    console.log("Arr length: " + arr.length);
    // console.log(JSON.stringify(arr));
}

function arrToPython() {
    var ctx = context;
    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var arr = [];
    var data = imageData.data;
    for (var i = 0; i < data.length; i += 4) {
        arr.push(data[i], data[i+1], data[i+2]);
    }

    $.ajax({
      url: "{{ url_for('savingImage') }}",
      type: "POST",
      data: {jsarr: JSON.stringify(arr)},
      success: function(response) {
        $('#calculatedResult').text(`Predicted value: ${response}`)
      },
      error: function(err) {
        $('#calculatedResult').text(`Something went wrong on server side`)
      }
    });
}


function saveImage() {
    if(imagename.value=="")
        alert("Image name cannot be empty") ; 
    else {
        $.post("/"+imagename.value,{imagename:imagename.value, string:JSON.stringify(data)});
        alert("saved");
    }
}

// function loadImage() {
//     if(imagename.value=="")
//      alert("Image name cannot be empty");
//  else {
//      document.location.href="/"+imagename.value; 
//  }
// }

function clearCanvas() {
    context.fillStyle="#000000";
    context.fillRect(0, 0, canvas.width, canvas.height);
    if (clickX.length !== 0) {
        clickX = new Array();
        clickY = new Array();
        clickDrag = new Array();
    }
}

function fillColor(color) {
    context.fillStyle = color;
    context.strokeStyle = color;
    currentColor = color;
    if (clickX.length !== 0 ) {
        // We used brush. In order to change color without modifying existing brush drawn image 
        // Let's update 
        clickX = new Array();
        clickY = new Array();
        clickDrag = new Array();
    }
}

function getMousePos(canvas, evt) {
    if (evt.pageX != undefined && evt.pageY != undefined) {
        var x = evt.pageX;
        var y = evt.pageY;
    }
    else {
        x = evt.clientX + document.body.scrollLeft +
                document.documentElement.scrollLeft;
        y = evt.clientY + document.body.scrollTop +
                document.documentElement.scrollTop;
    }

    x -= canvas.offsetLeft;
    y -= canvas.offsetTop;
    return {
        x: x,
        y: y
    };
}

function drawLine(x1, y1, x2, y2) {
    context.beginPath();
    // context.fillStyle="#FFFFFF";
    // context.fillRect(0, 0, canvas.width, canvas.height);
    // context.clearRect(0, 0, canvas.width, canvas.height);
    context.moveTo(x1, y1);
    context.lineTo(x2, y2);
    context.closePath();
    context.stroke();
} 

function drawRect(x1, y1, x2, y2) {
    // context.clearRect(0, 0, canvas.width, canvas.height);
    if(currentColor)
        context.fillRect(x1, y1, x2, y2);
    else
        context.strokeRect(x1, y1, x2, y2);    
}

function drawCircle(x1, y1, r) {
    // context.clearRect(0, 0, canvas.width, canvas.height);
    context.beginPath();
    context.arc(x1, y1, r, 0, Math.PI*2, false);
    context.closePath();
    if (currentColor) {
        context.fill();
    }
    else 
        context.stroke();
}

function drawBrush() {
    // context.clearRect(0, 0, context.canvas.width, context.canvas.height); // Clears the canvas
    // context.strokeStyle = currentColor;
    context.strokeStyle = currentColor;
    context.lineJoin = "round";
    context.lineWidth = 20;
    for (let i=0; i < clickX.length; i++) {
        context.beginPath();
        if (clickDrag[i] && i){
            context.moveTo(clickX[i-1], clickY[i-1]);
        } else {
            context.moveTo(clickX[i]-1, clickY[i])
        }
        context.lineTo(clickX[i], clickY[i])
        context.closePath();
        context.stroke();
    }
}

function drawAll() {
    if (data.line.length) {
        for (var i =0; i < data.line.length; i++) {
            fillColor(data.line[i].color);
            drawLine(data.line[i].beginx, data.line[i].beginy, data.line[i].endx, data.line[i].endy);
            context1.drawImage(canvas,0,0);
        }
    }
    if (data.rect.length) {
        for (var i =0; i < data.rect.length; i++) {
            fillColor(data.rect[i].color);
            drawRect(data.rect[i].beginx, data.rect[i].beginy, data.rect[i].sidex, data.rect[i].sidey);
            context1.drawImage(canvas,0,0);
        }
    }
    if (data.circle.length) {    
        for (var i =0; i < data.circle.length; i++) {
            fillColor(data.circle[i].color);
            drawCircle(data.circle[i].beginx, data.circle[i].beginy, data.circle[i].radius);
            context1.drawImage(canvas,0,0);
        }
    }
}

</script>
</html>
